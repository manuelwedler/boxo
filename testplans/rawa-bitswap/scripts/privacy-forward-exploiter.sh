#!/bin/bash

TEST_NAME="privacy (want-forward exploiter)"
RESULTS_DIR="results/privacy-forward-exploiter/"

run_testground (){
    FORWARD_DEGREE=$1
    testground run single \
        --builder=docker:go \
        --runner=local:docker \
        --plan=rawa-bitswap \
        --testcase=rawa-test \
        --instances=50 \
        --wait \
        -tp run_count=100 \
        -tp conn_per_node=4 \
        -tp unforwarded_search_time=2 \
        -tp proxy_transition_prob=0.2 \
        -tp forward_graph_degree=$FORWARD_DEGREE \
        -tp closest_peerid_forward=false \
        -tp forward_exploiter=true
}
# todo unforwarded search timer from evaluation
# todo proxy_transition_prob from evaluation

run() {
    echo "running $TEST_NAME evaluation..."
    mkdir -p $RESULTS_DIR
    # forward_graph_degree
    for n in 0 2 4
    do
        echo "running forward_graph_degree=$n"
        id=`run_testground $n | tail -n 2 | awk -F 'run with ID: ' '{ print $2 }'`
        testground collect --runner=docker:go $id
        echo "collected $id"
        tar -xf $id.tgz
        rm $id.tgz
        d=n{$n}
        mv $id $d
        mv $d $RESULTS_DIR
    done
}

run
